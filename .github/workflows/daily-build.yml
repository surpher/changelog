on: push

name: Daily build changelog

jobs:
  generate_changelog:
    name: "🧪 Generate changelog"
    runs-on: ubuntu-latest
    outputs:
      build_number: ${{ steps.buildnumber.outputs.build_number }}

    steps:
      - uses: actions/checkout@v1

      - name: "🔍 Fetch merge commit descriptions"
        id: merge_commits
        run: |
          echo "::set-output name=changelog::$(git log $(git tag --list 'build-number-*' --sort=-v:refname | head -1).. --merges --pretty=format:"%b")"

      - name: "#️⃣ Generate Build Number"
        id: buildnumber
        uses: einaregilsson/build-number@v2
        with:
          token: ${{ secrets.github_token }}

      - name: "Prepare changelog file"
        run: |
          echo ${{ steps.merge_commits.outputs.changelog }} 2>&1 | tee changelog-build-number-${{ steps.buildnumber.outputs.build_number }}

      - name: "Archive changelog"
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: changelog-build-number-${{ steps.buildnumber.outputs.build_number }}
          path: build/Artifacts
  
  build:
    name: "Changelog content"
    needs: [generate_changelog]
    runs-on: ubuntu-latest

    steps:
      - name: "Download Artifacts"
        uses: actions/download-artifact@v2
        with:
          name: changelog-${{ needs.generate_changelog.outputs.build_number }}
          path: build/Artifacts
      
      - name: "What's in the file?"
        run: |
          cat build/Artifacts/changelog-build-number-${{ needs.generate_changelog.outputs.build_number }}